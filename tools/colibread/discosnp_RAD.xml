<?xml version='1.0' encoding='utf-8'?>
<tool profile="16.04" id="discosnp_rad" name="DiscoSnpRAD" version="2.3.0">
    <description>discovering polymorphism from raw unassembled RADSEQ NGS reads.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="2.3.0">discosnp</requirement>
        <requirement type="package" version="1.1.0">shortreadsconnector</requirement>
    </requirements>
    <command><![CDATA[
        ## simple option
        #if str( $input_type_options.input_type) == "single"
            @discosnp_single_reads@
        ## paired option
        #else if str( $input_type_options.input_type) == "paired"
            @discosnp_paired_reads@
        ## mix option
        #else
            @discosnp_single_reads@
            @discosnp_paired_reads@
        #end if

        ## get the absolute path for short_reads_connector
        CONNECTOR_PATH=`which short_read_connector.sh` &&
        CONNECTOR_DIR=`dirname \$CONNECTOR_PATH` &&

        run_discoSnpRad.sh
        -r input.lst
        -S \$CONNECTOR_DIR
        -b ${b}
        -D ${D}
        -a ${a}
        -P ${P}
        ${low_complexity}
        -k ${k}

        #if str($coverage_options_type.coverage_options) == 'auto'
            -c auto
        #else
            -c '${coverage_options_type.c}'
        #end if
        -C ${C}
        -d ${d}
        -u 4

  ]]></command>

  <inputs>

      <conditional name="input_type_options">
          <param name="input_type" type="select" label="Input options">
              <option value="single">Single end reads</option>
              <option value="paired">Paired end reads</option>
              <option value="mix">Both single and paired reads</option>
          </param>
          <when value="single">
              <param name='list_reads' argument="-r" format="fasta,fastq" type="data" multiple="true" label="Single read files" />
          </when>
          <when value="paired">
              <param name='list_paired_reads' argument="-r" format="fasta,fastq" type="data_collection" collection_type="list:paired" multiple='true' label="List of paired read files" />
          </when>
          <when value="mix">
              <param name='list_reads' argument="-r" format="fasta,fastq" type="data" multiple="true" label="Single read files" />
              <param name='list_paired_reads' argument="-r" format="fasta,fastq" type="data_collection" collection_type="list:paired" multiple='true' label="List of paired read files"/>
          </when>
      </conditional>

      <param argument="-b" type="select" label="Branching strategy">
          <option value="1">forbid SNPs for wich the two paths are branching</option>
          <option value="2">No limitation on branching</option>
      </param>

      <param argument="-D" type="integer" label="Deletion size" value="100" help="discoSnpRad will search for deletions of size from 1 to D included"/>
      <param argument="-a" type="integer" label="Maximal size of ambiguity of INDELs" value="20" help="INDELS whose ambiguity is higher than this value are not output"/>
      <param argument="-P" type="integer" label="Maximum SNPs per bubble" value="5" help="discoSnpRad will search up to P SNPs in a unique bubble"/>
      <param name="low_complexity" type="boolean" checked="false" truevalue="-l" falsevalue="" label="Remove low complexity bubbles" />
      <param argument="-k" type="integer" label="Set the length of used kmers" value="31" />

      <conditional name="coverage_options_type" >
          <param name="coverage_options" type="select" label="Coverage option">
              <option value="auto"></option>
              <option value="custom"></option>
          </param>
          <when value="auto" />
          <when value="custom">
              <param argument="-c" type="text" label="Minimal coverage per read set" value="4" help="e.g. 4 / 4,5,17 / 4,auto,auto"/>
          </when>
      </conditional>

      <param argument="-C" type="integer" label="Maximal coverage per read set" value="2147483647" help="default value = 2^31-1" />
      <param argument="-d" type="integer" label="Max number of errors per read" value="1" help="Max number of errors per read" />

  </inputs>

  <outputs>
      <data name="vcf" from_work_dir="*_coherent_sorted_with_clusters.vcf" format="vcf" label="VCF with ${tool.name} on $on_string"/>
      <data name="fasta" from_work_dir="discoRad_*_coherent.fa" format="fasta" label="Fasta with ${tool.name} on $on_string"/>
  </outputs>

  <tests>
      <test>
          <conditional name="input_type_options">
              <param name="input_type" value="single"/>
              <param name="list_reads" value="discosnpRAD/loci_reads" ftype="fasta" />
          </conditional>
          <param name="k" value="31"/>
          <param name="b" value="2"/>
          <output name="fasta" file="discosnpRAD/fasta.fa"/>
          <output name="vcf" file="discosnpRAD/vcf_file.vcf" compare="diff" lines_diff="2"/>
      </test>
  </tests>

  <help><![CDATA[

**Description**

Software discoSnp is designed for discovering Single Nucleotide Polymorphism (SNP) from raw set(s) of reads obtained with Next Generation Sequencers (NGS).

DiscoSnpRad uses options specific to RAD-Seq: branching strategy, kind of extensions, abundance threshold, and kind of bubbles to be found.

Moreover, it clusters variants per locus by calling the `discoRAD_finalization.sh` pipeline. Cluster information is  reported in the final provided VCF file.

-------

.. class:: warningmark

**Input parameters**

-Sequences files in fasta or fastq each allele will be counted in each file individually

-Use collections: data list and/or data list paired

-Fasta sequence of a genome if case of you are willing to map the sequence extension on a reference in order to get a compliant VCF

-------

.. class:: warningmark

**Ouput parameters**

-VCF file with coordinates on the higher branch sequences or on a reference genome if provided

-Fasta file with sequence extensions around the SNP.


-------

**Web site**

https://colibread.inria.fr/software/discosnp/

  ]]></help>
    <expand macro="citations">
        <citation type="doi">10.1093/nar/gku1187</citation>
    </expand>
</tool>
